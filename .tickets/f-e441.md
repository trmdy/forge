---
id: f-e441
status: closed
deps: [f-f710, f-c44a]
links: []
created: 2026-01-10T20:10:34Z
type: task
priority: 1
assignee: Tormod Haugland
parent: f-c2d0
---
# Implement forged-side mail server (JSON-lines)

Implement the server side of Forge Mail inside forged.

Scope (per docs/forge-mail/SPEC.md + design ticket):
- Accept client connections over the chosen transport(s):
  - Unix socket (preferred) and/or TCP
- Implement JSON-lines protocol handling for:
  - send (persist message to disk and broadcast)
  - watch (stream messages to subscribers)
- Persist messages to the same .fmail/ file store layout used by standalone mode
- Broadcast to local subscribers in realtime
- Populate host field in connected-mode messages
- Maintain basic presence/registry updates when clients connect/send

Notes:
- File storage remains the source of truth.
- Cross-host sync/relay can be a follow-up ticket once local server is solid.

## Acceptance Criteria

- forged exposes the mail transport endpoint(s) decided in the design ticket
- Sending via forged writes the same message JSON files to .fmail/ as standalone mode
- watch streams new messages in realtime without polling
- Multiple subscribers can watch the same topic without missing messages
- Includes basic tests (at least one integration test that starts the server and exercises send+watch)


## Notes

**2026-01-11T07:54:23Z**

Implemented forged mail server with TCP+unix listeners, JSON-lines send/watch, and integration test. go test ./... fails in sandbox (go-build cache permission + httptest listen).
