---
id: f-f710
status: closed
deps: []
links: []
created: 2026-01-10T20:06:13Z
type: task
priority: 0
assignee: Tormod Haugland
parent: f-c2d0
---
# Design: fmail <-> forged connection + protocol

The Forge Mail spec assumes a simple JSON-lines client/server model with:
- Unix socket at .fmail/forged.sock (preferred)
- TCP fallback at localhost:7463

Forge currently has a forged daemon that uses gRPC (default 50051). Before implementation, lock down how Forge Mail transport works end-to-end.

Scope:
- Decide how fmail discovers forged (socket path rules, per-project vs global, how project root maps to a socket)
- Decide whether TCP 7463 is required; if so, define bind/port configuration
- Define JSON-lines protocol messages for: send, watch (and whether we need who/status/topics over the socket)
- Define error responses + retry/fallback behavior (when to fall back to standalone mode)
- Define how project ID + agent name + host are provided/validated when connected
- Define broadcast semantics for watch (ordering, backpressure, reconnect)

References:
- docs/forge-mail/SPEC.md (Forged Integration + Protocol)
- docs/forge-mail/DESIGN.md (edge cases, threat model)
- PROMPT.md (server-client model, projects across hosts)

## Acceptance Criteria

- Written protocol contract (schema + examples) exists in one place (either docs/forge-mail or this ticket) covering request/response for send and watch
- Socket discovery rules are explicitly defined (what fmail checks, in what order)
- Decision recorded on TCP fallback (keep/remove) and on whether forged must manage multiple projects concurrently
- Clear fallback rules: when fmail uses forged vs standalone, and how failures are surfaced to the user


## Notes

**2026-01-10T21:01:04Z**

Added docs/forge-mail/PROTOCOL.md with JSON-lines contract (send/watch), socket discovery order, TCP fallback decision, project scoping, errors, ordering, and fallback rules. Linked from SPEC/README.
