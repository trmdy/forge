---
id: f-54c2
status: open
deps: []
links: []
created: 2026-01-11T17:50:46Z
type: feature
priority: 2
assignee: Tormod Haugland
parent: f-3a50
---
# Add tags field to message schema

## Problem

Messages currently have no structured metadata for categorization. Users resort to:
- Encoding tags in the body: `"[urgent] fix auth bug"`
- Using topic names as categories (creates topic proliferation)
- Parsing body content for keywords

This makes filtering, routing, and organization difficult. Adding tags now (even without filtering) ensures forward compatibility.

## Solution

Add optional `tags` field to message schema:

```json
{
  "id": "20260111-153000-0001",
  "from": "architect",
  "to": "task",
  "time": "2026-01-11T15:30:00Z",
  "body": "fix authentication bug in login flow",
  "tags": ["urgent", "auth", "bug"]
}
```

CLI accepts `--tag` flag:

```bash
fmail send task --tag urgent --tag auth "fix login bug"
fmail send task --tag urgent,auth "fix login bug"  # Comma shorthand
```

## Implementation Notes

### Schema Changes

Update `internal/mail/message.go`:

```go
type Message struct {
    ID       string    `json:"id"`
    From     string    `json:"from"`
    To       string    `json:"to"`
    Time     time.Time `json:"time"`
    Body     any       `json:"body"`
    ReplyTo  string    `json:"reply_to,omitempty"`
    Priority string    `json:"priority,omitempty"`
    Host     string    `json:"host,omitempty"`
    Tags     []string  `json:"tags,omitempty"`  // NEW
}
```

### CLI Changes (cmd/fmail/send.go)

```go
var tags []string
cmd.Flags().StringSliceVar(&tags, "tag", nil, "Add tags to message (repeatable or comma-separated)")

// In send handler:
msg := mail.Message{
    // ...existing fields...
    Tags: tags,
}
```

### Protocol Changes (PROTOCOL.md)

Add `tags` to send request:

```json
{
  "cmd": "send",
  "to": "task",
  "body": "fix login bug",
  "tags": ["urgent", "auth"]
}
```

### Filtering (Deferred)

For v1.1, `--tag` on `fmail log` and `fmail watch` can be a no-op or simple client-side filter. Full server-side indexing/filtering comes later when forged needs it.

```go
// Simple client-side filter (v1.1)
func filterByTags(msgs []Message, wantTags []string) []Message {
    if len(wantTags) == 0 {
        return msgs
    }
    var filtered []Message
    for _, m := range msgs {
        if hasAnyTag(m.Tags, wantTags) {
            filtered = append(filtered, m)
        }
    }
    return filtered
}
```

### Validation

- Tags: lowercase alphanumeric with hyphens (same as topic names)
- Max 10 tags per message
- Max 50 chars per tag

```go
var tagRegex = regexp.MustCompile(`^[a-z0-9-]{1,50}$`)

func validateTags(tags []string) error {
    if len(tags) > 10 {
        return errors.New("max 10 tags per message")
    }
    for _, t := range tags {
        if !tagRegex.MatchString(t) {
            return fmt.Errorf("invalid tag: %s", t)
        }
    }
    return nil
}
```

## Acceptance Criteria

- [ ] `fmail send task --tag urgent "msg"` includes tag in message JSON
- [ ] `fmail send task --tag a,b,c "msg"` supports comma-separated tags
- [ ] Tags field appears in `fmail log --json` output
- [ ] SPEC.md updated with tags field documentation
- [ ] PROTOCOL.md updated with tags in send request
- [ ] Tag validation (format, count limits)
- [ ] Empty tags array omitted from JSON (`omitempty`)

## Why Now?

Adding tags to the schema is low-effort and enables:
- Future filtering by forged (index tags for fast queries)
- TUI organization (group by tag)
- Forge integration (priority mapping via tags)
- User categorization without topic proliferation

Deferring filtering implementation keeps scope small while establishing the schema.

## Related

- f-ab22: Priority mapping could use tags (e.g., `priority:high` tag)
- TUI inbox could group/filter by tags
