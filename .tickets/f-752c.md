---
id: f-752c
status: open
deps: []
links: []
created: 2026-01-11T17:50:42Z
type: feature
priority: 2
assignee: Tormod Haugland
parent: f-3a50
---
# Multi-topic watch support

## Problem

Currently `fmail watch` only accepts a single topic argument. To monitor multiple topics (e.g., `task` and `build`), users must spawn separate watcher processes. This is inefficient and complicates:

1. **TUI panels**: A mail inbox panel wants to show messages from multiple topics in one stream
2. **Mail routing**: Agents that need to react to messages from several topics
3. **Resource usage**: Each watcher polls at 100ms in standalone mode - N watchers = N polling loops

## Solution

Allow comma-separated topics or a `--topics` flag:

```bash
fmail watch task,build
fmail watch --topics task,build,status
fmail watch task,@myname  # Mix topics and DM inbox
```

## Implementation Notes

### CLI Changes (cmd/fmail/watch.go)

```go
// Parse comma-separated targets
targets := strings.Split(args[0], ",")
for _, t := range targets {
    t = strings.TrimSpace(t)
    if strings.HasPrefix(t, "@") {
        // DM inbox
        dmTargets = append(dmTargets, t[1:])
    } else {
        topicTargets = append(topicTargets, t)
    }
}
```

### Standalone Mode (internal/mail/watcher.go)

Modify polling loop to scan multiple directories:

```go
type MultiWatcher struct {
    topics []string
    dms    []string  // DM inboxes to watch
    since  time.Time
    seen   map[string]bool  // Dedupe by msg ID
}

func (w *MultiWatcher) Poll() ([]Message, error) {
    var msgs []Message
    for _, topic := range w.topics {
        topicMsgs, _ := w.store.ListMessages(topic, w.since)
        msgs = append(msgs, topicMsgs...)
    }
    for _, dm := range w.dms {
        dmMsgs, _ := w.store.ListDMs(dm, w.since)
        msgs = append(msgs, dmMsgs...)
    }
    // Sort by ID (chronological), dedupe
    sort.Slice(msgs, func(i, j int) bool { return msgs[i].ID < msgs[j].ID })
    return w.dedupe(msgs), nil
}
```

### Connected Mode (protocol change)

Extend watch request to accept multiple topics:

```json
{
  "cmd": "watch",
  "topics": ["task", "build"],
  "dms": ["myname"],
  "since": "2026-01-10T15:00:00Z"
}
```

Update PROTOCOL.md to document array syntax. Forged multiplexes internally.

### Output

Messages streamed in chronological order (sorted by ID) regardless of source topic. Each message already has `to` field indicating origin.

## Acceptance Criteria

- [ ] `fmail watch task,build` watches both topics
- [ ] `fmail watch task,@myname` watches topic + DM inbox
- [ ] Messages arrive in chronological order (by ID)
- [ ] Works in standalone mode (polling)
- [ ] Works in connected mode (forged)
- [ ] `--json` output unchanged (one message per line)
- [ ] PROTOCOL.md updated with array syntax

## Related

- f-de22: Cursor resume pairs well (watch multiple topics, resume from last ID)
- TUI inbox panel will use this
