---
id: f-4c08
status: open
deps: []
links: []
created: 2026-01-11T17:50:58Z
type: epic
priority: 3
assignee: Tormod Haugland
---
# EPIC: fmail v2 - Forge integration

## Overview

Deeper integration between fmail and Forge loops to create a unified agent communication system. Loops become first-class fmail citizens - they receive work via DMs, emit events to topics, and have full traceability from request to completion.

## Motivation

Currently, Forge loops and fmail are parallel systems:
- `forge msg` sends to internal queue
- `fmail send @agent` sends to fmail DM
- Loop state changes are invisible to fmail
- No traceability from "who asked" to "what happened"

This creates friction for multi-agent coordination:
- External agents can't easily send work to loops
- No event-driven coordination ("when X finishes, start Y")
- Can't audit "why did this iteration run?"

## Vision

```
┌─────────────────────────────────────────────────────────────┐
│                    Unified Agent Ecosystem                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  External Agents ──fmail DM──▶ Loop DM Inbox ──▶ Queue      │
│                                                              │
│  Loop ──events──▶ forge-events topic ──▶ Monitoring Agents  │
│                                                              │
│  Request ──trigger_id──▶ Ledger ──▶ Audit Trail             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## Children

| ID | Title | Priority | Status |
|----|-------|----------|--------|
| f-1e51 | Bridge forge msg and fmail DMs | P3 | open |
| f-89ec | Emit loop events to fmail topic | P3 | open |
| f-ab22 | Priority mapping: fmail to forge queue | P3 | open |
| f-0c8c | Multi-recipient DM fan-out with broadcast_id | P3 | open |
| f-b3a1 | Ledger traceability: store triggering fmail msg ID | P3 | open |

## Dependency Graph

```
f-1e51 (DM bridge)──────────┐
         │                  │
         ▼                  │
f-ab22 (priority mapping)   │
         │                  │
         └───────┬──────────┘
                 │
                 ▼
        f-b3a1 (ledger traceability)
                 │
                 ▼
        f-89ec (loop events)
                 
f-0c8c (broadcast) - independent
```

## Implementation Order

1. **f-1e51**: Bridge DMs - foundational, makes loops fmail-native
2. **f-ab22**: Priority mapping - builds on DM bridge
3. **f-b3a1**: Ledger traceability - captures trigger info
4. **f-89ec**: Loop events - completes the feedback loop
5. **f-0c8c**: Broadcast - independent, can be done anytime

## Key Design Decisions

### DM Consumption

Loops consume their DM inbox at iteration start:
- DMs converted to queue items
- Archived after processing (not deleted)
- FMAIL_AGENT set to loop name

### Event Topic

Reserved topic `forge-events` for loop lifecycle:
- Not a broadcast (separate event per loop)
- Configurable which events to emit
- Aggressive gc recommended (1 day retention)

### Traceability

Every ledger entry records:
- `trigger_source`: scheduled | fmail:<id> | queue:<id>
- `trigger_from`: Agent that sent the message
- `trigger_msg_id`: Original fmail message ID

## Success Criteria

- [ ] `fmail send @my-loop "task"` delivers work to loop
- [ ] Loops emit events to forge-events topic
- [ ] High-priority fmail messages jump queue
- [ ] Ledger shows what triggered each iteration
- [ ] Can send DMs to multiple agents with correlation
- [ ] External agents can coordinate via fmail alone

## Related

- f-3a50: fmail v1.1 (prerequisite improvements)
- docs/simplification-prd.md: Overall Forge architecture
